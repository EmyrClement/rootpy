#!/usr/bin/env python

# This script converts all TTrees in a ROOT file into HDF5 format.

import sys
import os
import traceback
import numpy
import tables
import ROOT
from rootpy import types as rtypes
from rootpy.utils.progressbar import *
from rootpy.io import open as ropen
from rootpy.root2tables import convert 

def main():

    if len(sys.argv) != 2:
        print "You must specify exactly one argument (the filename)"
        sys.exit(1)
    inputName = sys.argv[1]
    if not inputName.endswith(".root"):
        print "Input file does not have a .root extension"
        sys.exit(1)
    outputName = inputName.replace(".root",".h5")
    try:
        rootFile = ropen(inputName)
    except:
        print "Could not open %s" % inputName
        sys.exit(1)
    try:
        hd5File = openFile(filename=outputName, mode="w", title="Data")
    except:
        print "Could not create %s" % outputName
    try:
        convert(rootFile, hd5File)
    except KeyboardInterrupt:
        print
        print "Caught Ctrl-c ... cleaning up"
        hd5File.close()
        os.unlink(outputName)
    except:
        print
        print "Unexpected error:", sys.exc_info()[0]
        traceback.print_tb(sys.exc_info()[2])
        hd5File.close()
        os.unlink(outputName)
    hd5File.close()

if __name__=="__main__": main()
